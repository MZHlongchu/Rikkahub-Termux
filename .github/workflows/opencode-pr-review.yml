name: opencode-pr-review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  opencode:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Run opencode
        uses: anomalyco/opencode/github@latest
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_PAT }}
        with:
          model: openai/gpt-5.2-codex
          use_github_token: true
          prompt: |
            Review this pull request for correctness, security, maintainability, and performance regressions.
            Focus on logical bugs, edge cases, and behavior changes. Call out missing tests or insufficient coverage.
            Leave concise, actionable review comments and, when possible, suggest specific fixes or code patterns.
            Provide a short summary of the overall risk level and the most important issue. Do not ask questions or
            request confirmation; only leave the review.
